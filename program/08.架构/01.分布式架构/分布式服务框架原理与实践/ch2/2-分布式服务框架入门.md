
# 第 2 章 分布式服务框架入门

## 2.1 分布式服务架构诞生背景

传统垂直架构改造的核心对应用进行服务化，服务化改造使用到的核心技术就是分布式服务框架

### 2.1.1 应用从集中式走向分布式

* 通过新增硬件的方式对应用进行扩容，暂时顶住高峰期大并发对系统的冲击
  * 大型复杂系统开发维护成本高，部署效率低
  * 数据库连接数持续变高
  * 难以代码复用
  * 敏捷交付面临挑战
* 拆分策略
  * 纵向拆分：根据业务特性拆分
  * 横向拆分：服务提供者与消费者解耦

### 2.1.2 亟需服务治理

* 服务治理主要诉求
  * 生命周期管理
  * 服务容量规划
  * 运行期治理
  * 服务安全
* SOA服务治理生命周期
  * 计划：确定服务治理的重点
  * 定义：定义服务治理模型
  * 启动：实现并实施服务治理
  * 度量：根据实施效果，改进服务治理模式

## 2.2 业界分布式服务框架介绍

* 框架
  * 开源的分布式服务框架
    * 阿里巴巴的分布式服务框架Dubbo
    * 当当网基于Dubbo增强而来的DubboX
  * 非开源的分布式服务框架
    * 淘宝的HSF
    * 亚马逊的Coral Service
    * 华为的DSF

### 2.2.1 阿里 Dubbo

* Dubbo工作原理
  * 根据服务提供者配置文件发布服务
  * 服务发布者连接`服务注册中心`，注册服务
  * 服务消费者连接`服务注册中心`，获取服务地址
  * 服务注册中心根据服务订阅关系，动态推送服务地址信息
  * 从本地缓存的服务提供者地址列表中选择一个服务提供者，跨进程调动服务提供者
* Dubbo主要质量属性
  * 连通性
    * 注册中心负责服务地址的注册与查找
    * 监控中心负责统计服务调用情况
    * 服务消费者向注册中心获取服务提供者地址列表，调用提供者
    * 注册中心、服务提供者、服务消费者三者之间均为长连接，监控中心除外
    * 注册中心通过长连接感知服务提供者的存在
    * 消费者本地缓存提供者列表
    * 注册中心和监控中心都是可选的，服务消费者可以直连服务提供者
  * 健壮性
    * 监控中心宕机不影响使用，只丢失部分采样数据
    * 数据库宕机，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务
    * 注册中心任一台宕机，将自动切换到另一台
    * 注册中心全部宕机，服务提供者和服务消费者仍能通过本地缓存通信
    * 服务提供者无状态，任意一台宕机，不影响使用
  * 伸缩性
    * 客户端自动发现新的注册中心
    * 服务提供者无状态，可动态增加及其部署实例
  * 扩展性
    * 可通过插件扩展新功能或替换平台的默认实现
    * 管道式设计：通过服务调用前拦截，事后通知的方式，开放服务调用拦截面给框架使用者
    * 原子化扩展点

### 2.2.2 淘宝 HSF

* HSF框架功能总结
  * 配置化开发
  * 插件管理体系：平台与应用分开部署，内部采用OSGi隔离，外部用与应用独立的classloader隔离
  * 异步NIO通信，多种序列化方式
  * 灵活的路由能力
  * 多协议支持
  * 服务治理：服务监控、服务分组、限流降级、服务授权等

### 2.2.3 亚马逊 Coral Service

* Coral Service功能
  * 支持多协议
  * 轻量级架构
  * 配置化开发
  * 与DevOps

## 2.3 分布式服务框架设计

### 2.3.1 架构原理

* 分布式服务框架架构
  * RPC层：通信框架、序列化和反序列化框架
  * Filter Chain层：服务调用职责链，提供多种服务调用切面供框架自身和使用者扩展
  * Service层
    * Java动态代理将服务提供者的接口封装远程服务调用
    * Java反射根据消费者请求消息中的信息调用提供者的接口本地实现类
* 两个重要功能
  * 服务治理中心：服务治理接口和服务治理Portal
  * 服务注册中心：负责服务的发布和通知

### 2.3.2 功能特性

* 功能特性
  * 服务订阅发布
    * 配置化发布和引用服务
    * 服务自动发现
    * 服务注册
  * 服务路由
    * 随机、轮询、权重的路由策略
    * 粘滞连接：向同一个提供方发起请求，除非宕机
    * 路由定制
  * 集群容错
    * Failover：失败自动重试其他服务器，读操作
    * Failback：失败自动恢复，消息通知操作
    * Failfast：快速失败，写操作
  * 服务调用
    * 同步：同步阻塞等待服务端响应
    * 异步：不阻塞立即返回，服务端返回响应后异步通知消费者
    * 并行：批量发起请求，集中等待应答
  * 多协议
    * 私有协议：二进制等私有协议
    * 公有协议：Web Service等公有协议
  * 序列化方式
    * 二进制类序列化：Thrift, Protocol Buffer二进制，序列化性能
    * 文本类序列化：json, xml等，通用性和可读性
  * 统一配置
    * 本地静态配置
    * 基于配置中心的动态配置

### 2.3.3 性能特性    

* 性能特性
  * 高性能：单服务TPS要尽量高
  * 低时延：服务调用时延尽量低
  * 性能线性增长

### 2.3.4 可靠性

* 可靠性
  * 服务注册中心
    * 服务监控状态监测
    * 故障切换
    * 本地缓存通信
  * 消除单点故障
    * 服务无状态
    * 服务集群容错
  * 链路健壮性
    * 心跳监测：定时监测链路是否可用
    * 断连重连机制

### 2.3.5 服务治理    

* 服务治理
  * 服务运行态管控
    * 服务路由
    * 服务限流
    * 服务迁入迁出：资源的动态分配
    * 服务降级
    * 服务超时控制
  * 服务监控
    * 性能统计
    * 统计报表
    * 告警
  * 服务生命周期管理
    * 上线审批
    * 下线通知
    * 服务灰度发布
  * 故障快速定界定位
    * 分布式日志采集
    * 海量日志在线检索
    * 调用链可视化展示
    * 运行日志故障定位
  * 服务安全
    * 敏感服务的授权策略
    * 链路的安全防护
