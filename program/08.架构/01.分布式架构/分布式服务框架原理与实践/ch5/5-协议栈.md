

# 第 5 章 协议栈

## 5.1 关键技术点分析

### 5.1.1 是否支持多协议

* 多协议
  * 答案是否定的
  * 分布式服务框架与ESB最大的差异就是它不负责异构系统的对接

### 5.1.2 公有协议还是私有协议

* 公有还是私有
  * SOA
    * SOA重构已有的异构系统，实现不同系统之间的服务调用，使用标准的Web Service最佳
    * 服务提供者通过WSDL向注册中心提供服务接口描述
    * 注册中心通过UDDI发布服务提供者的服务
    * 服务消费者通过标准SOAP协议调用服务提供者
  * 分布式服务
    * 解决内部服务化之后业务接口跨进程通信问题
    * 吞吐率、时延等性能指标是关键
  * Web Service
    * SOAP消息使用XML进行序列化，性能低
    * SOAP通常由HTTP协议承载，一般使用短连接通信，性能比较差

### 5.1.3 集成开源还是自研

* 私有协议一般自研
  * 开源RPC框架协议栈与序列化框架，功能耦合
  * 开源方案功能满足度、灵活性很难满足业务需求
* 公有协议
  * 优先成熟的开源框架
  * 功能不多，可以基于通信框架Netty自研

## 5.2 功能设计

### 5.2.1 功能描述

* 私有协议栈的功能
  * 定义了私有协议的通信模型和消息定义
  * 支持服务提供者和消费者之间采用点对点长连接通信
  * 基于Java NIO通信框架，提供高性能的异步通信能力
  * 提供可扩展的编解码框架，支持多中年序列化格式
  * 握手和安全认证机制
  * 链路的高可靠性

### 5.2.2 通信模型

### 5.2.3 通信消息定义

* 协议栈消息模型
  * 消息头：存储协议公共字段和用户扩展字段
  * 消息体：用于承载消息内容

### 5.2.4 协议栈消息序列化的字段类型

* 需要在协议栈层面约束支持的数据结构类型

### 5.2.5 协议消息的序列化和反序列化

* 消息的序列化分为两部分
  * 消息头的序列化：定义标志序列化格式的字段，对消息头做通用解码，获取序列化格式
  * 消息头的编码规范
    * crcCode
    * length
    * type
    * priority
    * interfaceName
    * methodName
    * attachment
    * body

### 5.2.6 链路创建

* 握手请求消息
  * 消息头的type字段值为3
  * 可选附件个数为0
  * 消息体为空
* 握手应答消息
  * 消息头的type字段值为4
  * 可选附件个数为0
  * 消息体为byte类型的结果，0：认证成功：-1：认证失败

### 5.2.7 链路关闭

* 关闭连接
  * 对方宕机或重启
  * 消息读写过程中发生IO异常
  * 心跳消息读写过程中发生了IO异常
  * 心跳超时
  * 编码异常等不可恢复错误

## 5.3 可靠性设计

### 5.3.1 客户端连接超时

* 客户端连接超时
  * 不设置超时IO线程长时间阻塞
  * 业务流程执行时间有限制

### 5.3.2 客户端重连机制

* 重连
  * 客户端通过链路关闭监听器监听链路状态
  * 为了保证服务端正常释放句柄资源，首次断连客户端需要等待INTERVAL时间再发起重连
  * 客户端必须保证自身的资源被及时释放
  * 重连失败需要打印异常堆栈信息
  * 客户端对重连次数做限制

### 5.3.3 客户端重复握手保护

* 握手保护
  * 服务端
    * 服务端收到请求，对IP进行验证
    * 验证成功后，在缓存地址表查看是否已登录
      * 已登录则拒绝，关闭TCP链路，打印失败的握手日志
  * 客户端
    * 收到握手失败信息，关闭客户端TCP连接，等待重连
  * 心跳超时
    * 服务端连续N次心跳超时后主动关闭链路
    * 清空该客户端的地址缓存

### 5.3.4 消息缓存重发

* 消息缓存重发
  * 链路恢复后，重发消息
  * 消息缓存队列设置上限后，拒绝继续向该队列添加新的消息

### 5.3.5 心跳机制

* 心跳机制
  * 在网络空闲时采用心跳机制来检测链路的互通性
  * 一旦发现网络故障，立即关闭链路，主动重连

## 5.4 安全性设计

* 内部长连接采用基于IP地址的安全认证机制

## 5.5 最佳实践——协议的前后兼容性

* 设计原则
  * 消息头第一个字段中携带协议的版本号，用于标识消息协议版本
  * 消息头最后一个字段是Map类型的扩展字段，用于服务框架自身或者用户扩展消息头