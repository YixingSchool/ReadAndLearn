
# 第 9 章 服务注册中心

## 9.1 几个概念

* 概念
  * 服务提供者：发布服务的服务提供方
  * 服务消费者：调用远程服务的消费方
  * 服务注册中心
    * 支持数据持久化，支持集群
    * 数据一致性：集群中所有的客户端应该看到同一份数据
    * 数据变更主动推送

## 9.2 关键功能特性设计

### 9.2.1 支持对等集群

客户端只需要连接其中某一个即可（服务端之间自己进行数据同步）

### 9.2.2 提供CRUD接口

### 9.2.3 安全加固

* 服务注册中心安全加固
  * 链路的安全性
    * IP的黑名单
    * 用户名+密码
    * 秘钥+数字证书
  * 数据的安全性
    * 非授权客户端不能读写
    * 普通运维人员只能读取
    * 管理员可以读可写
    * 不同的服务目录设置不同的访问权限

### 9.2.4 订阅发布机制

* 订阅发布
  * 变化的监听和主动推送
  * 实时检测发布服务的质量
  * 推送新增的服务提供者地址

### 9.2.5 可靠性

## 9.3 基于ZooKeeper的服务注册中心设计

* ZooKeeper
  * 统一命名服务
  * 状态同步服务
  * 集群管理
  * 分布式应用统一配置
* ZooKeeper服务订阅发布流程
  * 创建org.apache.zookeeper.ZooKeeper实例，连接ZooKeeper服务器
  * create()创建一个给定路径的目录节点，并设置数据
    * CreateMode
      * PERSISTENT
      * PERSISTENT_SEQUENTIAL：顺序自动编号的目录界定啊
      * EPHEMERAL：临时目录节点，超时自动删除
      * EPHEMERAL_SEQUENTIAL
  * getData()
    * 根据消费的服务名获取对应的目录节点存储的数据
    * 更新本地缓存
  * 消费者监听服务提供者目录列表
  * 消费者通过监听者Watcher的process()获取变更的路径信息
  
### 9.3.2 服务健康状态检测

* 健康监测
  * 客户端和服务端建立连接后，生成一个全局唯一的Session ID
  * 在会话超时周期内，服务器监测与客户端的链路是否正常
  * 客户端定时发送心跳，服务器重置下次会话超时
  * 正常情况下，ZK集群上都保存这个Session信息
  * 一旦会话失效，ZK清理会话有关的信息

### 9.3.3 对等集群防止单点故障

* 对等集群
  * ZK集群由2n+1台Server组成，有n+1台Server可用
  * 读操作，由Follower的本地内存数据库直接给Client返回结果
  * 更新操作，交由Leader进行提议投票，超过半数通过后返回结果给Client
* Zab协议
  * 恢复模式：服务启动或Leader崩溃后，Zab进入恢复模式
  * 广播模式：选举出Leader，且大多数Server完成和Leader的状态同步
    * Leader提起一个决议，由Follower进行投票
    * Leader对投票结果进行计算决定是否通过该决议
    * 通过决议则执行该决议（事务）
    * ZK采用递增的事务id（zxid）保证决议按顺序处理
  * 同步过程
    * Follower连接Leader，将最大的zxid发送给Leader
    * Leader根据Follower的zxid确定同步点
    * 完成同步后通知Follower已经成为uptodate状态
    * Follower收到uptodate消息后，重新接受Client的请求进行服务

### 9.3.4 变更通知机制  

