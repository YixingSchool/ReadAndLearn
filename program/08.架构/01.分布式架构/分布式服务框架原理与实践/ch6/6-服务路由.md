

# 第 6 章 服务路由

## 6.1 透明化路由

* 透明化路由
  * 消费者只需要知道当前系统发布了哪些服务，而不需要知道服务具体存在于什么位置
  * 提供者发布服务地址信息和属性列表
  * 消费者从服务注册中心获取提供者列表，缓存到本地
  * 注册中心会主动将变更内容推送给服务消费者

## 6.2 负载均衡

* 随机路由算法缺点
  * 同一截面上碰撞概率高
  * 非对等集群组网内，各节点负载不均匀
* 轮询缺点
  * 慢的提供者累积请求
* 服务调用时延
  * 周期计算调用平均时延
  * 计算每个调用与平均时延的差值
  * 时延大的接收较少消息
* 一致性哈希
  * 相同参数的请求总是发到同一服务提供者
  * 当某一台提供者宕机，原请求平摊到其他提供者
* 粘滞连接
  * 用于有状态服务，让客户端总是向同一提供者发起服务调用

## 6.3 本地路由优先策略

* 本地优先
  * injvm，优先寻找本JVM内的服务提供者
  * innative
    * 先检查JVM内部
    * JVM内部没有，选择本地网卡回环调用服务提供者
    * 如果服务器内部找不到符合条件，则发起远程服务调用

## 6.4 路由规则

* 条件路由应用场景
  * 黑白名单控制
  * 流量引导
  * 读写分离
  * 灰度升级
* 条件路由的路由规则
  * 基于条件表达式的路由规则主要用于地址二次过滤
  * 组成
    * 规则
      * 消费者规则
      * 服务提供者规则
    * 表达式
      * 参数
      * 条件
      * 值
* 脚本路由规则
  * 动态编译，实时生效，不需重启

## 6.5 路由策略定制

* 自定义路由的应用场景
  * 用户需要按照业务规则进行灰度路由
  * 服务故障、业务高峰期的导流
  * 与业务领域强相关的非通用路由定制需求
* 路由扩展策略
  * 路由接口
  * XML配置
  * Spring Bean

## 6.6 配置化路由

* 路由配置策略设计
  * 本地配置：提供者和消费者、默认全局
  * 统一注册管理
  * 动态下发
* 路由配置优先级：客户端配置 > 服务端配置 > 全局配置

## 6.7 最佳实践——多机房路由

* 多机房路由
  * 不同机房共用一个服务注册中心
  * 不同机房的网段不同，根据网段条件匹配来实现地址过滤
  * 虚拟分组：将整个集群系统的服务提供者（跨机房）逻辑分成若干个组