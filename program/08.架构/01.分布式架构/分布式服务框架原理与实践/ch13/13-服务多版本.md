
# 第 13 章 服务多版本

## 13.1 服务多版本管理设计

* 服务版本号管理
  * 维护一个服务的不同版本是分布式服务框架支持服务在线升级的重要特性
  * 版本号划分原则
    * 主版本号：重大特性或功能变更，接口可能不兼容
    * 副版本号：部分变更
    * 微版本号：BUG修复
* 服务提供者
  * XML的Sevice Element需要包含version属性
  * 打包后的名称会包含服务的版本号信息
  * 微服务 + 全局版本模式
    * 经常发生功能变更，将其独立拆分出来进行微服务化
    * 对于其他服务，提供全局版本功能
* 服务消费者
  * 指定版本范围
    * 消费者关心的是某个新特性从哪个服务版本中开始提供
    * 希望自动适配最新的服务版本
* 基于版本号的服务路由
  * 服务名
  * 服务版本号
  * 服务分组
* 服务热升级
  * 停机升级的节点自动被隔离，停机并不会中断业务
  * 支持用户配置自定义路由规则来支持灵活的路由策略
  * 采用滚动升级的方式，分批次进行服务的热升级

## 13.2 与OSGI的对比

* OSGi Release 5
  * 核心规范
  * 标准服务（Standar Services）
  * 框架服务（Framework Services）
  * 系统服务（System Services）
  * 协议服务（Protocol Services）
  * 混合服务（Miscellaneous Services）
* 核心规范
  * OSGi Bundle的运行环境
  * OSGi Bundle间的依赖管理
  * OSGi Bundle的声明周期管理
  * OSGi服务的动态交互模型
* OSGi特性
  * 模块化
  * 热插拔机制

### 13.2.1 模块化开发

* 模块化开发
  * 模块被称为Bundle
  * 生命周期管理：打包、部署、运行、升级、停止
  * 模块中接口的导出、隐藏、依赖、版本管理、打包、部署、运行和升级
* OSGi
  * 每个OSGi工程是一个标准的插件工程
  * OSGi显式的管理package级的接口依赖关系
* Maven
  * Maven管理是jar包层面的依赖
  * 未实现package级和接口级的管理
  * Maven的模块化 + 分布式服务框架的服务接口导入导出功能 替代 OSGi的相关功能

### 13.2.2 插件热部署和热升级

* 插件的热部署和热升级
  * 基于自身的网状类加载机制实现
* 分布式服务框架实现服务热部署和热升级原理
  * 服务是分布式集群部署
  * 服务自动发现和隔离机制
  * 优雅停机功能
  * 集群容错功能
  * 服务多版本管理

### 13.2.3 不适用OSGI的其他理由

* 不使用OSGi其他理由
  * 应用迁移代价高
  * 框架代码复杂
  * Class Loading问题不优雅
  * 互相依赖及启动顺序问题棘手
  * 构建及调试不完善
  * 学习成本高
