
# 第 18 章 分布式消息跟踪

* 中间件
  * 分布式服务框架
  * 消息队列
  * 分布式缓存
  * 分布式数据访问中间件
  * 分布式文件存储系统
  * 分布式日志采集

## 18.1 业务场景分析

* 业务场景
  * 需要一种方式来直观的了解系统的调用及运行状况
* 故障的快速定界定位
  * 通过链跟踪，将一次业务调用的完整轨迹以调用链的形式展示出来
* 调用路径分析
  * 识别应用的关键路径
* 调用来源和去向分析
  * 应用直接和简介依赖了哪些服务
  * 各层次依赖的调用时延、QPS、成功率等性能KPI指标
  * 识别不合理的强依赖

## 18.2 分布式消息跟踪系统设计

* 调用链
  * 每次业务请求都生成一个全局唯一的TraceID
* 分布式消息跟踪系统的整体架构
  * 调用链埋点日志生成
  * 分布式采集和存储埋点日志
  * 在线、离线大数据计算，对调用链数据进行分析和汇总
  * 调用链的界面展示、排序和检索等
* 埋点日志
  * 埋点就是分布式消息跟踪系统在当前节点的上下文信息
  * 分类
    * 客户端埋点：客户端端发送请求消息时生成的调用上下文
    * 服务端埋点：服务端返回应答新校时在当前节点生成的上下文
  * 包含功能
    * 埋点规范
    * 埋点日志类库
    * 中间件预置埋点功能
  * 埋点日志上下文
  * 消息跟踪ID（TraceID）
    * TraceID是关联一次完整应用调用的唯一标识，需要在整个集群内唯一
  * RpcID标识日志埋点顺序和嵌套关系
  * 埋点日志的挑战
    * 异步调用：线程切换的埋点信息丢失
    * 性能影响：埋点日志阻塞应用线程
  * 埋点日志的改善
    * 异步写日志
    * 可配置的埋点采样率
    * 批量写日志
* 采样率
  * 静态采样：上线是设置一个
  * 动态采样：系统的负载可以自动调整
* 采集和存储埋点日志
  * 存储策略
    * 全量日志存HDFS和Elasticsearch
    * 增量实时日志、计算之后的日志存HBase
* 调用链扩展

## 18.3 总结

* 运维
  * 故障定界
  * 故障定位
  * 提前预警
  * 易故障点识别
* 运营
  * 热门应用识别
  * 调用来源分布
  * 产品调整
  * 营销策略优化
* 开发
  * 架构优化
  * 消除不合理依赖
  * 性能优化
* 测试
  * 识别调用流程
  * 优化测试用例
  * 关键路径覆盖率
