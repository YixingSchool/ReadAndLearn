

# 第1章 分布式服务案例

* 大流量、高并发、服务化架构改造；
* RPC和服务治理框架Dubbo落地服务化架构；
* 分布式调用跟踪系统帮助实施服务治理；
* 理清服务与服务之间的依赖关系、调用顺序、以及服务的执行耗时等；

## 1.1 分布式系统的架构演变过程

* 架构
  * 单机架构
  * 集群架构
  * 分布式架构
* 存储
  * 关系型数据库的分库分表
  * 本地缓存
  * 分布式缓存

### 1.1.1 单机系统

* 单机系统
  * 独立部署，避免争夺资源；
  * Web服务器集群；
  * 部署分布式缓存系统，查询在缓存命中；
  * 读写分离，实现HA（High Availability高可用性）架构；

### 1.1.2 集群架构

* 集群架构
  * Nginx负载均衡调度
  * 分布式缓存
  * 读写分离
  * CDN
  * 业务垂直化

### 1.1.3 拆系统之业务垂直化

* 垂直化
  * 降低业务耦合，实现高内聚低耦合，提升系统容错性；
  * 一般大型电商网站都会拆分出**首页、用户、搜索、广告、购物、订单、商品、收益结算等子系统**；
  * 实施服务化改造和数据库分库分表；

### 1.1.4 为什么需要实现服务化架构

* 服务化架构
  * 共享业务重复建设和资源连接受限；

### 1.1.5 服务拆分粒度之微服务

* 微服务
  * 共享的业务拆分成可复用的服务；
  * 子系统只是一个控制层，无须处理复杂业务，提升吞吐量；
  * 粒度越细，业务耦合越小，容错性越好；

## 1.2 系统服务化需求

### 1.2.1 服务化与RPC协议

* RPC
  * 服务调用以网络的形式进行远程调用
* 步骤
  * 底层的网络通信协议处理；
  * 解决寻址问题；
  * 请求/响应过程中参数的序列化和反序列化工作；

### 1.2.2 使用阿里分布式服务框架Dubbo实现服务化

* Dubbo
  * Provider对外提供服务
  * Consumer服务调用方
  * Registry提供服务的地址列表
  * Monitor服务监控

### 1.2.3 警惕Dubbo因超时和重试引起的系统雪崩

* Dubbo的Consumer会在本地根据负载均衡算法从地址列表中选择某一个服务节点进行RPC调用，如果调用失败则自动Failover到其他服务节点上，默认重试次数为两次。
* 写服务，不适合Failover，需要考虑幂等性，可能导致重复写；
* 读服务，适合开启Failover；

### 1.2.4 服务治理方案

* 服务治理要素
  * 服务的动态注册与发现
  * 服务的扩容评估
  * 服务的升降级处理
* 功能
  * 注册中心实现服务的动态注册和发现
  * 监控中心准确知道热点服务器
  * 对次要服务进行降级，牺牲部分功能保证核心服务
  * 路由规则、动态配置、服务降级、访问控制、权重调节及负载均衡

### 1.2.5 关于服务化后的分布式事务问题

## 1.3 分布式调用跟踪系统需求

* 分布式调用跟踪系统
  * 监控平台
  * 可视化请求的完整调用链
  * 收集调用链上服务的执行耗时
  * 整合孤立日志

EagleEye
Zipkin
Watchman

### 1.3.1 Google的Dapper论文简介

* 跟踪系统的四个关键设计目标
  * 服务性能低损耗
  * 业务代码低侵入
  * 监控界面可视化
  * 数据分析准实时
* 流程
  * 一次请求涉及的所有后端服务串联起来
  * 在服务或服务之间的调用过程中进行埋点和数据收集上报工作
  * **Trace**表示对一次请求的完整调用链追踪
  * **Span**理解为Trace的组成结构，服务的一次请求/响应过程

### 1.3.2 基于Dubbo实现分布式调用跟踪系统方案

* 基础功能
  * 跟踪请求的完整调用链
  * 收集调用链上服务的执行耗时，以及整合孤立日志
* 实现
  * 使用Filter拦截HTTP请求
  * Dubbo的Filter可以对服务提供方进行拦截，也可以拦截服务调用方
  * RpcContext临时状态记录器
  * 为同一个Trace中年的Span分配全局唯一的TraceID
  * 需要保证分布式环境中ID的唯一性，特别是兼顾连续性
  * 分配SpanID和ParentSpanID
  * 通过RpcInvocation传递Trace上下文
* 时间
  * Client Send Time（CS，客户端发送时间）
  * Client Receive Time（CR，客户端接收时间）
  * Server Receive Time（SR，服务端接收时间）
  * Server Send Time（SS，服务端发送时间）
* 执行耗时
  * 服务调用耗时=CR-CS。表示一次RPC请求响应所花费的总时间
  * 服务处理耗时=SS-SR。表示服务方法所花费的时间
  * 网络耗时=服务调用耗时-服务处理耗时。网络耗时直接影响系统的吞吐量
  * 前置网络耗时=SR-CS
  * 后置网络耗时=CR-SS

https://github.com/gaoxianglong/service-tracing

### 1.3.3 采样率方案

* 采样率
  * 服务的损耗主要在调用跟踪和数据收集上
  * 峰值流量较大时，只需采样一部分请求即可
  * 固定的采样率会错过用户流量小的情况
  * 采样率配置在配置中心，运维根据实际用户流量动态调整