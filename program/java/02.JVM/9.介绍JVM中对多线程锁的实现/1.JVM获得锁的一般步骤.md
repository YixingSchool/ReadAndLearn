

JVM获得锁的一般步骤 - 开源软件 - IT610.com http://www.it610.com/article/4881714.htm


JVM更高效的处理多线程之间的竞争，尽量避免在操作系统层面挂起线程。
(1)、偏向锁
线程获得对象后，先进入偏向模式，JVM把对象头部的锁标志位设置为01。同时用CAS操作把这个锁的线程ID记录在Mark Word中的偏向线程ID，并将是否偏向锁的状态位置置为1。
持有偏向锁的线程以后每次进入这个锁相关的同步块时，直接检查Thread ID是否和自身线程ID一致，如果一致，则认为当前线程已经获取了锁，虚拟机就可以不再进行任何同步操作。当有另外一个线程去尝试获取这个锁时，偏向模式就宣告结束。
 
(2)、轻量级锁
线程获得对象后，当对象没有被锁定。JVM首先将在当前线程的栈帧中建立一个BasicObjectLock，用于存储锁记录目前对象的Mark Word的拷贝。
然后，JVM使用CAS操作尝试将对象的Mark Word更新为BasicLock的地址。如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位将转变为00，即表示此对象处于轻量级锁定状态。如果，这个状态更新失败，说明这个对象被其他线程抢占，那么多个线程竞争导致锁膨胀。
 
(3)、锁膨胀
JVM使用Inflate()方法获得对象的Monitor，然后enter()方法尝试进入重量级锁。Mark Word的锁标志位将转变为10
 
(4)、自旋锁
JVM尝试使线程没有取得锁时候，不被挂起，转而执行一个空循环，在若干的循环后，线程获得锁则继续执行，如果没有获得锁被挂起。