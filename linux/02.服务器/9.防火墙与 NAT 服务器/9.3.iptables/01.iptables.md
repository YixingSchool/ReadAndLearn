
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 封包进入主机是有顺序的](#1-封包进入主机是有顺序的)
- [2. Linux防火墙iptables的表格（table）与链（chain）](#2-linux防火墙iptables的表格table与链chain)
  - [2.1 iptables的含义](#21-iptables的含义)
  - [2.2 iptables的表格和链](#22-iptables的表格和链)

<!-- /code_chunk_output -->

# 1. 封包进入主机是有顺序的

1. iptables是利用封包过滤的机制
    1. 根据表头数据与定义的规则来决定该封包是否可以进入主机或者是被丢弃

# 2. Linux防火墙iptables的表格（table）与链（chain）

https://blog.csdn.net/chengqiuming/article/details/70139623

## 2.1 iptables的含义

也就是IP表的意思，从软件的名称上体现了软件的组成，iptables是由最基本的多个表（table）组成，而且每个表用途都不一样，在每个表中，又定义了多个链（chain），通过这些链可以设置相应的规则和策略。
 
## 2.2 iptables的表格和链
1. Filter（过滤器）：主要跟进入Linux本机的数据包有关，是默认的table。
    1. INPTU：主要与进入Linux本机的数据包有关。
    2. OUTPUT：主要与Linux本机要送出去的数据包有关。
    3. FORWARD：与Linux本机没有关系，它可以传递数据包到后端计算机中，与NAT的table相关性较高。
2. NAT（地址转换）：这个表格主要用来进行来源与目的地的IP和port的转换，与Linux本机无关，主要与Linux主机后的局域网内计算机相关。
    1. PREROUTING：在进行路由判断前所要进行的规则（DNAT/REDIRECT）。
    2. POSTROUTING：在进行路由判断后所要进行的规则（SNAT/MASQUERADE）。
    3. OUTPUT：与发送出去的数据包有关。
3. Mangle（破坏者）：这个表格主要是在与特殊的数据包的路由标志有关，这个表有5个内置链：PREROUTING，POSTROUTING，OUTPUT，INPTU、FORWARD。


# 3. 本机的iptables语法

Linux之iptables(三、命令--->单主机) - 朝圣布达拉 - 博客园 https://www.cnblogs.com/duanxin1/p/9849832.html

iptables命令规则格式：
iptables [-t table] SUBCOMMAND chain [-m matchname[per-match-options]] -j targetname [per-target-options]
   　　　　四表  　　增删改查　　　五联　　　匹配条件(隐式/显式8个)　　　      jump处理工作(ACCEPT/REJECT等)　　

1. 规则管理：
-A：append，追加
-I：insert, 插入，要指明插入至的规则编号，默认为第一条
-D：delete，删除；(1) 指明规则序号；(2) 指明规则本身
-R：replace，替换指定链上的指定规则编号
-F：flush，清空指定的规则链
-Z：zero，置零
2. 链管理：面向内网白名单，面向互联网黑名单
-N：new, 自定义一条新的规则链
-X：delete，删除自定义的空的规则链
-P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：ACCEPT：接受；DROP：丢弃
-E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除
chain: PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING
3. 查看：
-L：list, 列出指定鏈上的所有规则，本选项须置后
-n：numberic，以数字格式显示地址和端口号
-v：verbose，详细信息
-vv 更详细，竖向显示(像mysql中的\G)
-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值
--line-numbers：显示规则的序号
4. 常用组合：
-vnL
-vvnxL --line-numbers
-S selected,以iptables-save 命令格式显示链上规则;可利用while read做循环也可写入执行脚本
5. 匹配条件
    1. 基本匹配条件：无需加载模块，由iptables/netfilter自行提供
        1. -s, --source address[/mask][,...]：源IP地址或范围
        2. -d, --destination address[/mask][,...]：目标IP地址或范围
        3. -p, --protocol protocol：指定协议，可使用数字如0（all）protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or“all“参看：/etc/protocols
        4. -i, --in-interface name：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING链
        5. -o, --out-interface name：报文流出的接口；只能应用于数据报文流出的环节，只应用于FORWARD、OUTPUT、POSTROUTING链
    2. 扩展匹配条件：需要加载扩展模块（/usr/lib64/xtables/*.so），方可生效，查看帮助 man iptables-extensions
        1. 隐式扩展：在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块
            1. tcp协议的扩展选项
                1. --source-port, --sport port[:port]：匹配报文源端口,可为端口范围
                2. --destination-port,--dport port[:port]：匹配报文目标端口,可为范围
                3. --tcp-flags mask comp
                    1. mask 需检查的标志位列表，用，分隔，例如 SYN,ACK,FIN,RST
                    2. comp 在mask列表中必须为1的标志位列表，无指定则必须为0，用,分隔
                4. --syn：用于匹配第一次握手，相当于：--tcp-flags SYN,ACK,FIN,RST SYN
            2. udp协议的扩展选项
                1. --source-port, --sport port[:port]：匹配报文的源端口或端口范围
                2. --destination-port,--dport port[:port]：匹配报文的目标端口或端口范围
            3. icmp协议的扩展选项（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。
                1. --icmp-type {type[/code]|typename}
        2. 显式扩展：必须使用-m选项指明要调用的扩展模块的扩展机制，要手动加载扩展模块[-m matchname [per-match-options]]
        3. 处理动作：-j targetname [per-target-options]
            1. 简单：ACCEPT，DROP
            2. 扩展：REJECT：--reject-with:icmp-port-unreachable默认
                RETURN：返回调用链
                REDIRECT：端口重定向
                LOG：记录日志，dmesg
                MARK：做防火墙标记
                DNAT：目标地址转换
                SNAT：源地址转换
                MASQUERADE：地址伪装
                ...
                自定义链：
        4. 显式扩展：必须显式地指明使用的扩展模块进行的扩展
        5. 使用帮助：CentOS 6: man iptables；CentOS 7: man iptables-extensions
            1. multiport扩展，以离散方式定义多端口匹配,最多指定15个端口，
                1. --source-ports,--sports port[,port|,port:port]...指定多个源端口
                2. --destination-ports,--dports port[,port|,port:port]...指定多个目标端口
                3. --ports port[,port|,port:port]...多个源或目标端口
                iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports 20:22,80 -j ACCEPT
            2. iprange扩展，指明连续的（但一般不是整个网络）ip地址范围
                1. --src-range from[-to] 源IP地址范围
                2. --dst-range from[-to] 目标IP地址范围

## 3.4 TCP, UDP, 端口

iptables [-AI 链] [-io 网络接口] [-p tcp,udp] \
    [-s 来源 IP/网域] [--sport 埠口范围] \
    [-d 目标 IP/网域] [--dport 埠口范围] -j [ACCEPT|DROP|REJECT]

范例：想要联机进入本机 port 21 的封包都抵挡掉：
iptables -A INPUT -i eth0 -p tcp --dport 21 -j DROP
范例：想连到我这部主机的网芳 (upd port 137,138 tcp port 139,445) 就放行
iptables -A INPUT -i eth0 -p udp --dport 137:138 -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport 139 -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --dport 445 -j ACCEPT
只要来自 192.168.1.0/24 的 1024:65535 埠口的封包，且想要联机到本机的 ssh port 就予以抵挡，可以这样做：
iptables -A INPUT -i eth0 -p tcp -s 192.168.1.0/24 --sport 1024:65534 --dport ssh -j DROP
范例：将来自任何地方来源 port 1:1023 的主动联机到本机端的 1:1023 联机丢弃
iptables -A INPUT -i eth0 -p tcp --sport 1:1023 --dport 1:1023 --syn -j DROP