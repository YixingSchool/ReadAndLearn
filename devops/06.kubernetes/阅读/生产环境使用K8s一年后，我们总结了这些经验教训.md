

生产环境使用K8s一年后，我们总结了这些经验教训_搜狐科技_搜狐网 
http://www.sohu.com/a/127037247_515888

容器集成、网络、部署自动化是非常棘手的问题。

## 通过Kubernetes实现负载均衡

在Kubernetes集群前配置负载均衡器，例如HAProxy或者NGINX。

ingress的功能，用来直接从Kubernetes配置外部负载均衡器

## 配置负载均衡

配置放在了etcd里。confd的工具观察etcd中的配置变动，并用模板生成了一个新的HAProxy配置文件。当一个新的服务添加到Kubernetes，我们向etcd中添加一个新的配置，一个新的HAProxy配置文件也就此产生。

## 蓝绿部署

蓝绿部署是一种不中断服务的部署。与滚动更新不同，蓝绿部署在旧版本仍然正常工作的情况下，通过启用一个运行着新版本的副本集群来实现更新。当新版本的副本集群完全启动并运行时，负载均衡器配置才会更改并将负载切换到新版本上。

## 实现部署自动化

构建服务器可以调用新版本应用并自动部署至测试环境。同一个镜像也可以通过触发生产环境中的Deployer被推送上生产

## 资源限制

建议尽早设置和测试资源限制，防止容器因分配内存不足而意外停止

## 日志

容器将日志发送给Kafka，Kafka交给Graylog进行索引。应用组件将日志打给Kafka，方便将日志流式化，成为易于索引的格式

## 监控

应用组件将指标发布到InfluxDB，并用Heapster去收集Kubernetes的指标。我们还通过Grafana（一款开源仪表盘工具）使存储在InfluxDB中的指标可视化。有很多InfluxDB／Grafana堆栈的替代方案，无论你才用哪一种，对于运行情况的跟踪和监控都是非常有价值的。

## 数据存储和Kubernetes

Kubernetes具有Volume机制