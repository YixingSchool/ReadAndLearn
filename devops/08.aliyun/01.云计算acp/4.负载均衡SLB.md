1. https://help.aliyun.com/product/27537.html

# 2. 产品简介
## 2.1 什么是负载均衡
https://help.aliyun.com/document_detail/27539.html
> 负载均衡由以下三个部分组成：
  * 负载均衡实例 （Server Load Balancer instances）
    * 一个负载均衡实例是一个运行的负载均衡服务，用来接收流量并将其分配给后端服务器。要使用负载均衡服务，您必须创建一个负载均衡实例，`并至少添加一个监听和两台ECS实例`。
  * 监听 （Listeners）
    * 监听用来检查客户端请求并将请求转发给后端服务器。监听也会对后端服务器进行健康检查。
  * 后端服务器（Backend Servers）
    * 一组接收前端请求的ECS实例。您可以单独添加ECS实例到服务器池，也可以通过虚拟服务器组或主备服务器组来批量添加和管理。
## 2.2 基础架构
https://help.aliyun.com/document_detail/27544.html
阿里云当前提供四层（TCP协议和UDP协议）和七层（HTTP和HTTPS协议）的负载均衡服务。
* 四层采用开源软件LVS（Linux Virtual Server）+ keepalived的方式实现负载均衡，并根据云计算需求对其进行了个性化定制。
* 七层采用Tengine实现负载均衡。Tengine是由淘宝网发起的Web服务器项目，它在Nginx的基础上，针对有大访问量的网站需求，添加了很多高级功能和特性。
## 2.3 功能概述
https://help.aliyun.com/document_detail/32460.html
> 负载均衡支持的调度算法：
  * 轮询
  * 加权轮询（WRR）
  * 加权最小连接数（WLC）
  * 一致性哈希（CH）调度算法。
# 3. 产品定价 
## 3.2 按量计费
https://help.aliyun.com/document_detail/27692.html
> 带宽费 = 当日带宽峰值（元/小时）× 使用时长
  * 按带宽计费的公网SLB实例按小时计费，以日结算。`使用时间不足一小时，按一小时计算。运行未满一日，按照当日实际使用小时数乘以当日开通的最高带宽单价计算`。
# 5. 用户指南
## 5.2 监听
### 5.2.2 添加UDP监听
https://help.aliyun.com/document_detail/86130.html
UDP协议多用于关注实时性而相对不注重可靠性的场景，如视频聊天、金融实时行情推送等。您可以添加一个UDP监听转发来自UDP协议的请求。
### 5.2.3 添加HTTP监听
https://help.aliyun.com/document_detail/85949.html
* HTTP协议适用于需要对数据内容进行识别的应用，如Web应用、小的手机游戏等。您可以添加一个HTTP监听转发来自HTTP协议的请求。
* 图片请求，文字请求
### 5.2.4 添加HTTPS监听
https://help.aliyun.com/document_detail/86438.html
> 在上传证书前，请注意：
  * 上传的证书格式必须是PEM。详情参见证书要求。
  * 证书上传到负载均衡后，`负载均衡即可管理证书，不需要在后端ECS上绑定证书`。
### 5.2.8 监听介绍
https://help.aliyun.com/document_detail/85943.html
* 负载均衡提供四层（TCP/UDP协议）和七层（HTTP/HTTPS协议）监听
## 5.3 健康检查
### 5.3.1 健康检查介绍
https://help.aliyun.com/document_detail/85958.html
> 如果您的`业务对负载敏感性高，高频率的健康检查探测可能会对正常业务访问造成影响`。您可以结合业务情况，`通过降低健康检查频率、增大健康检查间隔、七层检查修改为四层检查等方式`，来降低对业务的影响。但为了保障业务的持续可用，不建议关闭健康检查。
> HTTP/HTTPS监听健康检查机制
  * 针对七层（HTTP或HTTPS协议）监听，健康检查通过`HTTP HEAD探测`来获取状态信息。
> TCP监听健康检查机制
  * 针对四层TCP监听，为了提高健康检查效率，健康检查通过定制的`TCP探测`来获取状态信息
> UDP监听的检查机制如下：
  * LVS节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】发送UDP报文。
  * 如果后端ECS相应端口未正常监听，则系统会返回类似返回 port XX unreachable的ICMP报错信息；反之不做任何处理。
  * 如果在【响应超时时间】之内，LVS节点服务器收到了后端ECS返回的上述错误信息，则认为服务异常，判定健康检查失败。
  * 如果在【响应超时时间】之内，LVS节点服务器没有收到后端ECS返回的任何信息，则认为服务正常，判定健康检查成功。
> 健康检查时间窗
  * 健康检查机制的引入，有效提高了业务服务的可用性。但是，为了避免频繁的健康检查失败引起的切换对系统可用性的冲击，健康检查只有在健康检查时间窗内连续多次检查成功或失败后，才会进行状态切换。健康检查时间窗由以下三个因素决定：
    * 健康检查间隔 (每隔多久进行一次健康检查)
    * `响应超时时间` (等待服务器返回健康检查的时间)
    * 检查阈值 (健康检查连续成功或失败的次数)
  * 健康检查时间窗的计算方法如下：
    * 健康检查失败时间窗=响应超时时间×不健康阈值+检查间隔×(不健康阈值-1)
### 5.3.3 配置健康检查
https://help.aliyun.com/document_detail/85959.html
> 健康检查协议
  * 监听为TCP协议时，`健康检查方式可选TCP或HTTP模式`。
    * TCP模式的健康检查是基于网络层探测。
    * HTTP模式的健康检查是通过发送head请求。
    * TCP 监听支持 TCP 和 HTTP 两种方式进行健康检查，HTTP 监听只支持 HTTP 方式健康检查
> 健康检查响应超时和健康检查间隔示例
以如下健康检查配置为例：

响应超时时间：5秒
健康检查间隔：2秒
健康阈值：3次
不健康阈值：3次

`ECS 健康检查失败响应时间` = (健康检查间隔+响应超时)*不健康阈值,即(2+5)×3=21 秒
`ECS 健康检查成功响应时间` = 健康检查间隔*健康阈值,即 2×3=6 秒

健康检查失败时间窗 = 响应超时时间×不健康阈值+检查间隔×(不健康阈值-1)，即5×3+2×（3-1）=19s。
健康检查成功时间窗 = (健康检查成功响应时间×健康阈值)+检查间隔×(健康阈值-1)，即（1×3）+2×（3-1）=7s。

## 5.5 转换证书格式
### 5.5.5 转换证书格式
https://help.aliyun.com/document_detail/85970.html
* 负载均衡只支持PEM格式的证书，其它格式的证书需要转换成PEM格式后，才能上传到负载均衡。建议使用Open SSL进行转换。
## 5.8 监控
### 5.8.2 设置报警规则
https://help.aliyun.com/document_detail/85933.html
https://help.aliyun.com/document_detail/32470.html （旧）
# 6. API参考
## 6.1 API概览
https://help.aliyun.com/document_detail/27566.html
ModifyLoadBalancerInternetSpec	修改负载均衡实例的计费方式或规格。
## 6.4 RAM鉴权
https://help.aliyun.com/document_detail/27575.html
> 可授权的负载均衡资源类型
  * LoadBalancer
  * Certificate
  * ACL
## 6.9 后端服务器
https://help.aliyun.com/document_detail/27635.html
> ServerHealthStatus 后端服务器的健康状况：
  * normal：后端服务器健康。
  * abnormal：后端服务器不健康。
  * `unavailable`：未完成健康检查。
# 7 产品限制
## 7.1 使用限制
https://help.aliyun.com/document_detail/32459.html
> SLB实例限制
  * 一个账号可创建的SLB实例数量	60
  * 一个ECS实例可关联SLB的次数	50
  * 一个SLB实例可添加的后端服务器数量	200
  * `一个SLB实例可添加的监听数量`	50
  * 一个HTTP/HTTPS监听可添加的域名和URL转发规则数量	40
  * 一个HTTPS监听可创建的扩展域名数量	3
  * 一个AccessKey的API访问频率限制	5000次/天
  * SLB实例监听可选择的前端/后端端口范围（公共云）	1-65535
  * SLB实例监听可选择的前端/后端端口范围（金融云）	80/443/2800-3300/5000-10000/13000-14000
> 证书限制
  * `每个地域可上传的服务器证书数量`	100
  * 每个地域可上传的客户端CA证书数量	100
> 访问控制策略组限制
  * 每个地域可创建的访问策略控制组数量	50
  * 一个访问控制策略组可添加的访问控制条目数量	300
  * 一次API调用可在访问控制策略组中添加的IP条目数	50
  * 一个访问控制策略组可以被关联到监听的次数	50
# 8 扩展阅读
## 8.1 最佳实践
### 8.1.3 配置服务器Cookie
https://help.aliyun.com/document_detail/27704.html
> 负载均衡服务提供会话保持功能。开启会话保持功能后，负载均衡会将会话期间内来自同一客户端的访问请求分发到同一台后端服务器上进行处理。
  * 四层监听的会话保持是`基于IP地址`的会话保持，负载均衡监听器会将来自同一IP地址的请求转发到同一个后端ECS上；而七层监听是`基于Cookie`的会话保持。
### 8.1.4 获取客户端真实IP
https://help.aliyun.com/document_detail/54007.html
> 负载均衡提供获取客户端真实IP地址的功能，该功能默认是开启的。
  * 四层负载均衡（TCP协议）服务可以`直接在后端ECS上获取客户端的真实IP地址`，无需进行额外的配置。
  * 七层负载均衡（HTTP/HTTPS协议）服务需要对应用服务器进行配置，然后`使用X-Forwarded-For的方式`获取客户端的真实IP地址。  
### 8.1.6 从负载均衡服务中移除ECS实例
https://help.aliyun.com/document_detail/52707.html
> 直接从后端服务器池中移除ECS实例可能会造成业务中断，建议您先将ECS的权重设置为零后，再移除。
## 8.2 常见问题
### 8.2.2 负载均衡常见问题
https://help.aliyun.com/knowledge_detail/55193.html
> 负载均衡支持哪些调度算法？
  * 可以使用轮询、加权轮询（WRR）、加权最小连接数（WLC）这三种调度方法：
    * 轮询：按照访问次数依次将外部请求依序分发到后端ECS上。
    * 加权轮询：您可以对每台后端服务器设置权重值，权重值越高的服务器，被轮询到的次数（概率）也越高。
    * 加权最小连接数：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。
> 如何避免负载均衡服务本身的故障问题？
  * 添加不同可用区的ECS实例作为负载均衡实例的后端服务器，从而提高本地可用性。
  * 在同一地域创建多个负载均衡实例，通过DNS轮询的方式对外提供服务，从而提高本地可用性。
  * 在不同地域创建多个负载均衡实例，通过DNS轮询的方式对外提供服务，从而提高跨地域的可用性。
### 8.2.3 后端服务器常见问题
https://help.aliyun.com/knowledge_detail/55198.html
> 1. 负载均衡实例最多支持添加多少ECS实例？
  * 默认每个SLB实例可以添加200个ECS实例，一个ECS实例可以被50个SLB实例关联。
> 3. 后端ECS实例的操作系统是否可以不同？
  * 可以。
  * 负载均衡本身不会限制后端ECS实例使用哪种操作系统，只要确保后端ECS实例中的应用服务部署相同且数据一致即可。但建议使用相同的操作系统，以便您日后的管理维护。
> 4. 可以使用不同地域的ECS实例作为后端服务器么？
  * 不可以。
  * 负载均衡不支持跨地域部署。负载均衡实例的地域和后端ECS实例的地域必须相同。
### 8.2.4 健康检查常见问题
https://help.aliyun.com/knowledge_detail/55205.html
> 3. 是否可以关闭健康检查？
  * 您`只可能关闭HTTP/HTTPS监听的健康检查，不能关闭TCP/UDP监听的健康检查`
> 7. 为什么有100开头的IP在频繁访问ECS实例？
  * 负载均衡系统除了会通过系统服务器的内网IP将来自外部的访问请求转到后端ECS实例之外，还会对ECS实例进行健康检查和可用性监控，这些访问的来源都是由负载均衡系统发起的。
  * `负载均衡系统的地址段为100.64.0.0/10（100.64.0.0/10 是阿里云保留地址`，其他用户无法分配到该网段内，不会存在安全风险），所以会有很多100开头的IP地址访问ECS实例。
  * 为了确保您对外服务的可用性，确保对上述地址的访问配置了放行规则。
> 5. ECS实例权重设置为零对健康检查有什么影响？
  * 该状态下，负载均衡不会再将流量转发给该ECS实例，且四层监听的后端服务器健康检查会显示异常（七层监听不会显示异常）。
  * `将负载均衡后端ECS实例的权重置为零，相当于将该ECS实例移出负载均衡`。一般是在ECS实例进行重启、配置调整等主动运维时将其权重设置为零。
  * 设置 ECS 权重为 0 后，这台 ECS 上已经建立的长链接依然在；而移除的话，已有的长链接会断掉. 
  * 对于新建连接，设置 ECS 权重为 0 和移除操作后，新连接都不会转到目标机器上。
  * `所以设置 ECS 权重为 0 并不是将 ECS 直接移出。`
> 轮询转发
  * 负载均衡同时设置权重和最小连接数，分发规则最小连接数优先，同时设置权重和轮询转发，权重优先。
  * https://help.aliyun.com/document_detail/27781.html
  * `负载均衡如果同时设置了加权最小连接数或加权轮询`，分发规则会先检查权重再通过设置的最小连接数或轮询进行分发；
### 8.2.8 为什么请求不均衡
https://help.aliyun.com/knowledge_detail/66280.html
> 负载均衡请求不均衡的原因可能有以下几种可能：
  * 开启了`会话保持`功能
    * 配置了会话保持，当访问负载均衡实例的客户端又很少时，容易导致不均衡，尤其在使用少量客户端对负载均衡进行测试的时候。比如TCP监听，开启了会话保持（四层是基于来源地址做会话保持），使用一台客户端对负载均衡实例进行压测，就会导致不均衡。
  * ECS`健康检查`异常
    * 后端服务器ECS的健康建状态异常会导致不均衡，尤其在压测的时候容易忽略后端服务器ECS的健康检查状态，如果有后端服务器ECS健康检查失败或者健康检查状态经常跳跃（好到坏，又从坏到好，反复变化）必然会导致不均衡。
  * TCP Keepalive保持长连接
    * 后端服务器ECS有些开启了TCP Keepalive保持长连接，而有些又没有开启，则连接会在保持长连接的后端服务器上堆积，造成不均衡。
> 排查和解决方法
  * 查看后端各台ECS的权重是否相同；
  * 在相关时间段内是否有健康检查失败或波动现象，查找波动的原因；或者健康检查没有配置正确的响应码2xx，3xx导致了健康检查显示正常，但后端服务有异常；
  * 是否同时使用了加权最小连接数（WLC）调度方式和会话保持，如果是，尝试改为加权加权轮询（WRR）算法和会话保持。
### 8.2.12 HTTPS/HTTP监听常见问题
https://help.aliyun.com/knowledge_detail/55201.html
7. 可以使用PKCS#12（PFX）格式的证书么？
可以。但在上传证书前，您需要将证书转换为PEM格式，详情参见转换证书格式。
# 9 教程专区 
## 9.6 基于域名/URL路径进行转发
https://help.aliyun.com/document_detail/85955.html
# 其他
1. [SLB 配置获取真实IP](https://help.aliyun.com/knowledge_detail/60529.html)
X-Forwarded-For 是一个 HTTP 扩展头部，用来表示 HTTP 请求端真实 IP。
2. [规划与准备](https://help.aliyun.com/document_detail/27548.html)
> 为了提供更加稳定可靠的负载均衡服务，阿里云负载均衡已在各地域部署了多可用区以实现同地域下的跨机房容灾。此外，您也可以在不同地域创建多个负载均衡实例，`通过DNS轮询的方式对外提供服务，从而提高跨地域的可用性`。
  * 为了减少延迟并提高下载速度，建议选择离您客户最近的地域。
  * 由于负载均衡不支持跨地域部署，因此应选择与后端ECS实例相同的地域。
3. 负载均衡注意事项
  * 1,如果在伸缩组中指定了负载均衡实例，伸缩组会自动将加入伸缩组的 ECS 实例添加到指定的负载均衡实例当中。
  * 2,`指定的负载均衡实例必须是已启用状态`。
    * Active（启用状态）：当创建好负载均衡实例后，在到期之前，您的负载均衡实例都是启用状态。此种状态下，您可以正常使用负载均衡实例。
    * https://help.aliyun.com/document_detail/74811.html
  * 3,指定的负载均衡实例所有配置的监听端口必须开启健康检查，否则创建失败。
  * 4,如果负载均衡实例已挂载了 VPC 类型的 ECS 实例，则不支持该负载均衡实例加入伸缩组。
  * 5,加入负载均衡的 ECS 实例的权重默认为 50。